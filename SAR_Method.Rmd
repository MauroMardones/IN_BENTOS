---
title: "![](IEO-logo2.png){width=10cm}"
output:
  bookdown::pdf_document2:
    includes:
      before_body: titulo.sty
    keep_tex: yes
    number_sections: no
    toc: true
    toc_depth: 3
bibliography: INBENTO.bib
csl: apa.csl
link-citations: yes
linkcolor: blue
indent: no
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhf{}
- \lfoot[\thepage]{}
- \rfoot[]{\thepage}
- \fontsize{12}{22}
- \selectfont
---
\newpage

```{r setup1, echo =FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      dev = 'jpeg',
                      dpi = 300, 
                      fig.align='center')
#XQuartz is a mess, put this in your onload to default to cairo instead
options(bitmapType = "cairo") 
# (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
```

```{r libs}
library(tidyverse)
library(ggridges)
library(readxl)
library(here)
library(lubridate)
library(readr)
library(ggthemes)
library(hrbrthemes)
library(kableExtra)
library(gtsummary)
library(egg)
library(ggthemes)
```



# CONTEXTO

# DATA

Existen tres tipos de archivos que contienen los datos de fauna y registros.  Entre ellos, lo comun es la Columna `Estación` . Los archivos son `Datos_estaciones_ACUVEN_3D_IN-BENTO.xlsx`,  `Fauna_danos_all.xlsx` y `Station.xlsx`

El archivo `Station.xlsx` tieme el area asociada
[@Indicator]

```{r}
fauna <- read_excel(here("DATOS",
                         "Fauna_danos_all.xlsx"))
station <- read_excel(here("DATOS",
                         "Station.xlsx"))
rendi <- read_excel(here("DATOS",
                         "Datos_estaciones_ACUVEN_3D_IN-BENTO.xlsx"),
                         skip = 3)
```
## Datos Fauna

```{r eval=FALSE}
unique(fauna$ID_FINAL)
names(fauna)
```

Agrupar por diversas variables 

```{r}
cantes <- fauna %>% 
  group_by(ID_FINAL) %>%
  summarize(SUM = sum(`Total Indiv...49`,
                                     na.rm = TRUE),
            SUMPES = sum(`Peso total (g)...50`))

indsum <- ggplot(cantes %>% 
                   drop_na(ID_FINAL))+
  geom_col(aes(x =ID_FINAL, y= SUM, fill=ID_FINAL))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90,
                                     hjust = 1,
                                     vjust = 0.5,
                                     size = 8),
        legend.position = "none")
  

pessum <- ggplot(cantes %>% 
                   drop_na(ID_FINAL))+
  geom_col(aes(x =ID_FINAL, y= SUMPES, fill=ID_FINAL))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 90,
                                     hjust = 1,
                                     vjust = 0.5,
                                     size = 5),
        legend.position = "none")
```


```{r}
indsum
```


```{r}
pessum
```

## Datos Lances

```{r message=FALSE}
setrendi <- rendi %>% 
  group_by()

den <- ggplot(rendi)+
  geom_point(aes(Estaciones, dens))+
  theme_few()

bio <- ggplot(rendi)+
  geom_col(aes(Estaciones, bio))+
  theme_few()

ren <- ggplot(rendi)+
  geom_col(aes(Estaciones, rend))+
  theme_few()

area <- ggplot(rendi)+
  geom_point(aes(area, rend))+
  geom_smooth(aes(area, rend))+
  theme_few()

ggarrange(den, bio , ren, area, ncol=2)
```
Entender las profundidades 

```{r message=FALSE}
f <- ggplot(rendi)+
  geom_histogram(aes(depth_f),
                 binwidth = 1,
                 fill = "transparent", color = "red")+
  theme_few()
i <- ggplot(rendi)+
  geom_histogram(aes(depth_i),
                 binwidth = 1,
                 fill = "transparent", color = "blue")+
  theme_few()
m <- ggplot(rendi)+
  geom_histogram(aes(depth_m),
                 binwidth = 1,
                 fill = "transparent", color = "green")+
  theme_few()

ggarrange(f, i , m , ncol=3)
```

## Analisis jerarquicos



# Unir bases

```{r}
names(fauna)
names(station)
names(rendi)
```
Cambio el nombre estación en `fauna`

```{r echo=TRUE}
fauna1 <- fauna %>% 
  rename("Estaciones"="ESTACIÓN") %>% 
  mutate(Estaciones = as.double(str_replace(Estaciones, "^E0*", ""))) %>% 
  drop_na(Estaciones)
```


```{r echo=TRUE}
base1  <- left_join(rendi, fauna1,
                   by="Estaciones")
```
```{r echo=TRUE}
glimpse(base1)

```


# MAPAS

Ahora produzco un mapa de las `Zonas De Producción`. Estos datos vectoriales fueron obtenidos desde la paina oficial de datos espaciales de la Junta de Andalucia [Shapesfile](https://portalrediam.cica.es/descargas?path=%2F08_AMBITOS_INTERES_AMBIENTAL%2F02_LITORAL_MARINO%2F04_SOCIOECONOMIA%2FZonasProduccionMoluscos)

Para ello tengo una seré de `.shp` para ir explorando.

Debo identificar clsaramete los poligonos utilizados en coquina.

## Leo Shapes y transformo a la proyección correcta.
```{r echo=FALSE, message=FALSE, warning=FALSE}

costandalucia <- st_read(here("SHP_Chirla",
                              "costa_proyectada.shp"))
grilla <- st_read(here("SHP_Chirla",
                              "cuadriculas_definitivo.shp"))

#zonapro <- st_read('~/IEO/DATA/Shapefiles_Andalucia/ZonasProduccionMoluscos.shp')
zonapro <- st_read('~/IEO/DATA/Shapefiles_Andalucia/zzpp_resolucion_2023_25830.shp')
zonape <- st_read('~/IEO/DATA/Shapefiles_Andalucia/05_09_ZonaIdoneaPesca.shp')
fisicomar <- st_read('~/IEO/DATA/Shapefiles_Andalucia/05_01_FisiograficoMarino.shp')
playas <- st_read('~/IEO/DATA/Shapefiles_Andalucia/playas.shp')
lito <- st_read('~/IEO/DATA/Shapefiles_Andalucia/05_02_Litologia.shp')
hidro <- st_read('~/IEO/DATA/Shapefiles_Andalucia/red_hidrografica.shp')
cuencas <- st_read('~/IEO/DATA/Shapefiles_Andalucia/cuencas.shp')
costa <- st_read('~/IEO/DATA/Shapefiles_Andalucia/costa_proyectada.shp')
```
## Transforma data
```{r message=FALSE, warning=FALSE}
grilla1 <- st_transform(grilla, "+init=epsg:4326")
costandalucia1 <- st_transform(costandalucia, "+init=epsg:4326")
zonapro1 <- st_transform(zonapro, "+init=epsg:4326")
zonape1 <- st_transform(zonape, "+init=epsg:4326")
fisicomar1 <- st_transform(fisicomar, "+init=epsg:4326")
playas1 <- st_transform(playas, "+init=epsg:4326")
lito1 <- st_transform(lito, "+init=epsg:4326")
spain1 <- st_transform(spain, "+init=epsg:4326")
portug1 <- st_transform(portug, "+init=epsg:4326")
cuencas1 <- st_transform(cuencas, "+init=epsg:4326")
#lmarino1 <- st_transform(lmarino, "+init=epsg:4326")
hidro1 <- st_transform(hidro, "+init=epsg:4326")
costa1 <- st_transform(costa, "+init=epsg:4326")
#chile1 <- st_transform(chile, "+init=epsg:4326")
```

# Mapa
 
```{r warning=FALSE}
mas <- ggplot() +
  geom_sf(data = grilla1, fill="white", color="red") +
  geom_sf(data = costandalucia1, fill="white") +
  #geom_sf(data = zonapro1, aes(fill=ZONA)) +
  # geom_sf(data = fisicomar1, alpha=0.1,
  #         linetype=5) +
  scale_fill_viridis_d(option="H",
                       alpha=.5)+
  coord_sf() +
  xlab(expression(paste(Longitude^o,~'O'))) +
  ylab(expression(paste(Latitude^o,~'S')))+
  # ggrepel::geom_label_repel(
  #   data = zonapro1,
  #   aes(label = ZONA, geometry = geometry),
  #   stat = "sf_coordinates",
  #   min.segment.length = ,
  #   colour = "black",
  #   size = 2,
  #   segment.colour = "black",
  #   box.padding = 0.7,
  #   max.overlaps = 50) +
  theme_few()+
  theme(legend.position = "none")+
  xlim(-7.6,-6)+
  ylim(36.6, 37.4)
mas
```

\newpage

# REFERENCIAS
